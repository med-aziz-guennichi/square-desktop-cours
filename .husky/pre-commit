#!/bin/sh

# TEMP FILE to detect loop
HOOK_GUARD_FILE=".git/.prettier-hook-guard"

# Skip the hook if we're already inside an auto-format commit
if [ -f "$HOOK_GUARD_FILE" ]; then
  echo "Detected loop, skipping hook..."
  rm "$HOOK_GUARD_FILE"
  exit 0
fi

echo "Running lint..."
bun run lint

echo "Running prettier..."
prettier --write "**/*.{ts,tsx,mdx}" --cache

# If prettier made changes, commit them and mark this run
if [ -n "$(git status --porcelain)" ]; then
  echo "Prettier made changes, committing them..."
  touch "$HOOK_GUARD_FILE"
  git add .
  git commit -m "chore: apply prettier formatting"
fi
